#!/usr/bin/env bash
# commit-msg hook: Conventional Commits + newline hygiene
# - Reject literal "\n" sequences in the commit message
# - Enforce CC subject line format via regex
# - Optional cocogitto verification

MSG_FILE="$1"

# 1) Reject literal \n sequences
if grep -q '\\n' "$MSG_FILE"; then
  echo "[commit-msg] Found literal '\\n' in commit message. Use real newlines or multiple -m flags."
  exit 1
fi

# 2) Extract subject and validate Conventional Commits format
subject=$(sed -n '1{s/[ \t]*$//;p}' "$MSG_FILE")
if [ -z "$subject" ]; then
  echo "[commit-msg] Empty commit subject."
  exit 1
fi

cc_regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9._-]+\))?!?: .+'
if ! printf '%s' "$subject" | grep -Eq "$cc_regex"; then
  echo "[commit-msg] Subject does not follow Conventional Commits:" >&2
  echo "  Got: $subject" >&2
  echo "  Expected: type(scope)?: subject" >&2
  echo "  Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert" >&2
  exit 1
fi

# 3) Optional subject length check
if [ ${#subject} -gt 100 ]; then
  echo "[commit-msg] Subject exceeds 100 characters (limit: 100)." >&2
  exit 1
fi

# 4) Best-effort cocogitto verification of recent history
if command -v cog >/dev/null 2>&1; then
  if [ "${COG_STRICT:-0}" = "1" ]; then
    echo "[commit-msg] Running cocogitto verify (strict) on recent history..."
    cog verify --from HEAD~20 --to HEAD
    if [ $? -ne 0 ]; then
      echo "[commit-msg] cocogitto verify failed (strict mode). Fix history or set COG_STRICT=0 to make it non-blocking." >&2
      exit 1
    fi
  else
    cog verify --from HEAD~5 --to HEAD >/dev/null 2>&1 || echo "[commit-msg] warning: cocogitto verify reported issues (non-blocking)."
  fi
fi

exit 0
