#!/usr/bin/env bash
# commit-msg hook: minimal checks + stateless nonce-based retry
# Performs only:
#  1) Reject literal \n sequences in the message
#  2) Validate Conventional Commits with cocogitto and capture subject
#  3) Enforce subject length <= 100
# Flow:
#  - On first attempt (no M40LLM_COMMIT_NONCE), compute a deterministic nonce from the
#    staged diff and message content, display diff and message with the nonce, then
#    abort the commit with instructions to retry using that nonce.
#  - On retry, if M40LLM_COMMIT_NONCE matches the computed nonce for the current staged
#    diff and message, allow the commit without interaction.

set -u
MSG_FILE="$1"

# 1) Reject literal \n sequences
if grep -q '\\n' "$MSG_FILE"; then
  echo "[commit-msg] Found literal \\n in commit message. Use real newlines or multiple -m flags." >&2
  exit 1
fi

# 2) Validate with cocogitto and capture subject
subject=$(sed -n '1{s/[ \t]*$//;p}' "$MSG_FILE")
if ! cog verify --file "$MSG_FILE" >/dev/null 2>&1; then
  echo "[commit-msg] cocogitto verify failed on the commit message file." >&2
  exit 1
fi

# 3) Subject length check (<= 100)
subject_len=${#subject}
if [ "$subject_len" -gt 100 ]; then
  echo "[commit-msg] Subject is ${subject_len} characters (max 100). Please shorten it." >&2
  exit 1
fi

# Compute deterministic nonce from staged diff + message content
staged_diff=$(git --no-pager diff --cached --no-color || true)
diff_hash=$(printf "%s" "$staged_diff" | sha256sum | awk '{print $1}')
msg_hash=$(sha256sum "$MSG_FILE" | awk '{print $1}')
nonce=$(printf "%s" "$diff_hash:$msg_hash" | sha256sum | cut -c1-16)

# If nonce is provided, verify match and allow commit
if [ -n "${M40LLM_COMMIT_NONCE:-}" ]; then
  if [ "$M40LLM_COMMIT_NONCE" = "$nonce" ]; then
    echo "[commit-msg] Nonce validated. Finalizing commit." >&2
    exit 0
  else
    echo "[commit-msg] Provided nonce does not match current staged diff/message. Aborting." >&2
    echo "[commit-msg] expected: $nonce" >&2
    exit 1
  fi
fi

# No nonce provided: show details and abort with instructions
echo "=== START OF COMMIT DIFF (staged) ==="
printf "%s\n" "$staged_diff"
echo "=== END OF COMMIT DIFF ==="

echo "=== START OF COMMIT MESSAGE ==="
cat -- "$MSG_FILE"
echo "=== END OF COMMIT MESSAGE ==="

echo "[commit-msg] Deterministic nonce for this staged diff + message: $nonce" >&2
echo "[commit-msg] To finalize, retry the same commit with the nonce set, for example:" >&2
echo "  M40LLM_COMMIT_NONCE=$nonce git commit -F $MSG_FILE --no-verify" >&2
# Note: users using 'git commit' interactively can re-run with -m or -F and the nonce set.
exit 1
