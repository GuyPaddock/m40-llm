#!/usr/bin/env bash
# commit-msg hook: Conventional Commits + newline hygiene
# - Reject literal "\n" sequences in the commit message
# - Enforce CC subject line format via regex
# - Optional cocogitto verification

MSG_FILE="$1"

# 1) Reject literal \n sequences
if grep -q '\\n' "$MSG_FILE"; then
  echo "[commit-msg] Found literal '\\n' in commit message. Use real newlines or multiple -m flags."
  exit 1
fi

# 2) Validate with cocogitto; also capture subject for length policy
subject=$(sed -n '1{s/[ \t]*$//;p}' "$MSG_FILE")
cog verify --file "$MSG_FILE" >/dev/null 2>&1 || {
  echo "[commit-msg] cocogitto verify failed on the commit message file." >&2
  exit 1
}

# 3) Optional subject length check
subject_len=${#subject}
if [ "$subject_len" -gt 100 ]; then
  echo "[commit-msg] Subject is ${subject_len} characters (max 100). Please shorten the subject line." >&2
  exit 1
fi

# 4) Reject vague 'fmt' messages; describe what changed and why instead
if grep -Ei '\bfmt\b' "$MSG_FILE" >/dev/null; then
  echo "[commit-msg] Avoid using 'fmt' in the commit message. Describe what changed and why, not the steps taken (e.g., running formatters). See .gitmessage for guidance." >&2
  exit 1
fi

# 5) Optional strict history check with cocogitto
if command -v cog >/dev/null 2>&1 && [ "${COG_STRICT:-0}" = "1" ]; then
  echo "[commit-msg] Running cocogitto check (strict) on recent history..."
  cog check --from-latest-tag || cog check || {
    echo "[commit-msg] cocogitto check failed (strict mode)." >&2
    exit 1
  }
fi

exit 0
