#!/usr/bin/env bash
# commit-msg hook: minimal checks + interactive diff confirmation
# Performs only:
#  1) Reject literal \n sequences in the message
#  2) Validate Conventional Commits with cocogitto and capture subject
#  3) Enforce subject length <= 100
# If all pass, prints the staged diff and asks the user to confirm the message
# properly represents what changed and why, and that the CC type fits.

set -u
MSG_FILE="$1"

# 1) Reject literal \n sequences
if grep -q '\\n' "$MSG_FILE"; then
  echo "[commit-msg] Found literal \\n in commit message. Use real newlines or multiple -m flags." >&2
  exit 1
fi

# 2) Validate with cocogitto and capture subject
subject=$(sed -n '1{s/[ \t]*$//;p}' "$MSG_FILE")
if ! cog verify --file "$MSG_FILE" >/dev/null 2>&1; then
  echo "[commit-msg] cocogitto verify failed on the commit message file." >&2
  exit 1
fi

# 3) Subject length check (<= 100)
subject_len=${#subject}
if [ "$subject_len" -gt 100 ]; then
  echo "[commit-msg] Subject is ${subject_len} characters (max 100). Please shorten it." >&2
  exit 1
fi

# All checks passed: show diff and ask for confirmation
echo "=== START OF COMMIT DIFF (staged) ==="
# Show staged diff without pager and color for clarity
if ! git --no-pager diff --cached --no-color; then
  echo "[commit-msg] Failed to obtain staged diff." >&2
fi
echo "=== END OF COMMIT DIFF ==="

# Ask the question, then show the commit message with delimiters
echo "Question: Does the commit message that follows properly represent what changed and why in the diff above?"
echo "Additionally, does it have the correct Conventional Commits type for what changed?"

echo "=== START OF COMMIT MESSAGE ==="
cat -- "$MSG_FILE"
echo "=== END OF COMMIT MESSAGE ==="

# Require explicit yes/no from the user
prompt() {
  printf "%s" "Does the commit message properly represent what changed and why, and is the CC type correct? [yes/no]: "
}

answer=""
# Prefer /dev/tty when available to ensure interactivity
while true; do
  if [ -r /dev/tty ]; then
    prompt >/dev/tty
    read -r answer </dev/tty
  elif [ -t 0 ]; then
    prompt
    read -r answer
  else
    echo "[commit-msg] Interactive confirmation required, but no TTY is available. Aborting commit." >&2
    exit 1
  fi
  case "${answer,,}" in
    yes|y)
      exit 0
      ;;
    no|n)
      echo "[commit-msg] Commit aborted. Please revise the commit message and try again." >&2
      exit 1
      ;;
    *)
      # Loop until unambiguous answer
      if [ -r /dev/tty ]; then echo "Please answer 'yes' or 'no'." >/dev/tty; else echo "Please answer 'yes' or 'no'." >&2; fi
      ;;
  esac
done
